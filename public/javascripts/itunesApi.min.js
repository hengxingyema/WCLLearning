var app=angular.module("yemaWebApp",[]),navIndex=2;app.controller("itunesSearchControl",function($scope,$http,$location){function getDemandObject(appObjectId){for(var i=0;i<demandList.length;i++)if(demandList[i].appObjectId==appObjectId)return demandList[i]}function getDemand(){if(void 0!=$scope.selectedApp){var inlineAppTaskDemand=getDemandObject($scope.selectedApp.appObjectId);if(void 0!=inlineAppTaskDemand){$scope.remarkChange(),$scope.displayDemandTemplate=inlineAppTaskDemand;var appPriceStr=$scope.selectedApp.formattedPrice;return"免费"!=appPriceStr&&toastr.info("付费游戏必须要首次下载"),$scope.calYCoin(),void $scope.getKeyAsoRank()}var getneedUrl="/myapp/getNeed/"+$scope.selectedApp.appObjectId;$http.get(getneedUrl).success(function(response){response.appDemandInfo.appObjectId=$scope.selectedApp.appObjectId,demandList.push(response.appDemandInfo),$scope.displayDemandTemplate=response.appDemandInfo;var appPriceStr=$scope.selectedApp.formattedPrice;"免费"!=appPriceStr&&toastr.info("付费游戏必须要首次下载"),$scope.remarkChange(),$scope.calYCoin(),$scope.getKeyAsoRank();var url="myapp/verify";$scope.insufficientFund=!1,$http.get(url).success(function(response){$scope.isManager=response.isManager,$scope.usermoney=response.usermoney,moneyCheck()})})}}function refreshAddBtn(){$scope.inviteCount>$scope.myApps.length-1?$("button.btn_addApp").attr("data-target","#addApp_modal"):$("button.btn_addApp").attr("data-target","#invite")}function releaseTask(){var excCount=$scope.displayDemandTemplate.excCount,excPrice=$scope.displayDemandTemplate.excUnitPrice,gettaskURL="/myapp/checkSendTask";$scope.errorMsg="";var btn=$("#myButton");btn.button("loading"),excCount>0?$http.post(gettaskURL,{excCount:excCount,excPrice:excPrice}).success(function(response){btn.button("reset"),0==response.errorId?$("#releaseTaskApp1").modal("show"):response.errorId==-10?($scope.errorMsg=response.errorMsg,$("#releaseTaskApp").modal("toggle")):($scope.errorMsg=response.errorMsg,$("#releaseTaskApp2").modal("toggle"))}):$("#releaseTaskApp1").modal("show")}function moneyCheck(){var excCount=$scope.displayDemandTemplate.excCount;if(void 0!=excCount&&excCount>0){var excUnitPrice=$scope.displayDemandTemplate.excUnitPrice,taskMoney=excCount*excUnitPrice;taskMoney>$scope.usermoney?($scope.insufficientFund=!0,console.log("money "+$scope.usermoney+"not enough, need "+excUnitPrice+", total"+taskMoney)):($scope.insufficientFund=!1,console.log("money "+$scope.usermoney+"not enough, need "+excUnitPrice+", total"+taskMoney))}}var url="myapp/verify";$scope.insufficientFund=!1,$scope.inviteUrl="http://www.mustangop.com/user/register/"+getCookie("userIdCookie"),$scope.copyUrl=function(){$("#alert-btn").popover("toggle");var Url=document.getElementById("inviteUrlcopy");Url.select(),document.execCommand("Copy")},$http.get(url).success(function(response){$scope.isManager=response.isManager,$scope.usermoney=response.usermoney});var userYCoinGoodsUrl="/shop/yCoinGoods";$scope.userYCoinGoods=[],$http.get(userYCoinGoodsUrl).success(function(response){0==response.errorId?$scope.userYCoinGoods=response.userYCoinGoods:toastr.error(response.message)});var demandList=[];saveAction=function(){var btn=$("#saveReportForm");btn.button("loading"),document.taskInfo.action="",document.taskInfo.submit()},$scope.isLoadingMyApp=!0,$scope.numOfApps=10,$scope.selectedApp=void 0,$scope.inviteCount=0;var appsUrl="myapp/angular";$scope.myApps=[],$http.get(appsUrl).success(function(response){$scope.isLoadingMyApp=!1,$scope.numOfApps=response.myApps.length,$scope.inviteCount=response.inviteSucceedCount,$scope.Limit=response.Limit,$scope.numOfApps>0&&($scope.myApps=response.myApps.sort(function(a,b){return a.createdAt>b.createdAt}),refreshAddBtn(),$scope.selectedApp=$scope.myApps[0],$scope.isDisabled=!1,getDemand())}),$scope.selectedAppFunc=function(app){$scope.selectedApp=app,$scope.isDisabled=!1,getDemand()},$scope.releaseTaskVideo=function(){$("#releaseTaskVideo").modal("hide");var myVideo=document.getElementById("release");myVideo.pause()},$scope.taskNumberChange=function(){var userInputNumb=document.getElementById("userInputNum").value;userInputNumb<=0&&($scope.userInputNum=!0),moneyCheck()},$scope.down=!1,$scope.checkBoxChange=function(checkboxId){document.getElementById(checkboxId).checked?($scope.displayDemandTemplate.excUnitPrice+=3,$scope.commentYCoin=!0):($scope.displayDemandTemplate.excUnitPrice-=3,$scope.commentYCoin=!1),moneyCheck()},$scope.payUrl=$location.absUrl().replace(/myapp/,"user#/YRecharge"),$scope.jumppay=function(){window.open($scope.payUrl)},$scope.homeUrl=$location.absUrl().replace(/myapp/,"home"),$scope.jumphome=function(){window.location.href=$scope.homeUrl},$scope.progressNum=0;var searchLocked=!1;$scope.searchApp=function(){if($scope.inviteCount<$scope.numOfApps)$scope.invite1=!0,$scope.invite2=!1;else if($scope.isError=0,""!=$scope.searchUrl&&0==searchLocked){var searchUrl="api/itunes/search/"+$scope.searchKey;$scope.progressNum=100,console.log("--------- searchApp searchApp"),searchLocked=!0,$http.get(searchUrl).success(function(response){if(searchLocked=!1,console.log("searchApp"+response),$scope.appResults=response.appResults,$scope.progressNum=0,response.errorMsg.length>0)$scope.isError=1,$scope.errorMsg=response.errorMsg;else{$scope.errorMsg=response.errorMsg,$scope.isError=0!=response.errorId;for(var i=0;i<$scope.appResults.length;i++){var appRe=$scope.appResults[i];appRe.isMine=!1;for(var j=0;j<$scope.myApps.length;j++){var myApp=$scope.myApps[j];if(myApp.appleId===appRe.appleId){appRe.isMine=!0,console.log(appRe.appleId+"isMine");break}}}}})}},$scope.keySearchApp=function(e){var keycode=window.event?e.keyCode:e.which;13==keycode&&$scope.searchApp()},$("body").on("click",function(event){var target=$(event.target);target.hasClass("popover")||0!==target.parent(".popover-content").length||0!==target.parent(".myPopover").length||0!==target.parent(".popover-title").length||0!==target.parent(".popover").length||"folder"===target.attr("id")||$("#pupop").popover("hide")}),$scope.isLoadingApp=!0,$scope.updateApp=function(appObjectId){$scope.isLoadingApp=!1,$scope.errorMsg="";var updateAppURL="/myapp/UpdateApp";$http.post(updateAppURL,{appObjectId:appObjectId}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,0==response.errorId?($scope.errorMsg=response.errorMsg,$scope.isLoadingApp=!0,toastr.success(response.errorMsg,{timeOut:2e3}),$scope.selectedApp.version=response.newAppObject.version,$scope.selectedApp.latestReleaseDate=response.newAppObject.latestReleaseDate,$scope.selectedApp.isUpdated=response.newAppObject.isUpdated,$scope.selectedApp.appleId=response.newAppObject.appleId):toastr.error(response.errorMsg)})},$scope.chooseMyApp=function(appInfo){if(1!=appInfo.isBinlding){var searchUrl="myapp/add";appInfo.isBinlding=!0,$http.post(searchUrl,{appInfo:appInfo}).success(function(response){if(appInfo.isBinlding=!1,0==response.errorId||void 0===response.errorId){appInfo.isMine=!0;var flag=0;void 0==$scope.myApps&&($scope.myApps=new Array);for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appInfo.appleId){flag=1;break}}0==flag&&($scope.selectedApp=response.newApp,$scope.isDisabled=!1,getDemand(),$scope.myApps.push(response.newApp),console.log($scope.myApps),$scope.numOfApps++,refreshAddBtn()),$scope.searchKey="",$scope.appResults=[],$("#addApp_modal").modal("hide")}else toastr.error(response.errorMsg),$scope.errorMsg=response.errorMsg})}},$scope.releaseBtnClick=function(app){$scope.prepareReleaseApp=app},$scope.releaseMyApp=function(){var searchUrl="myapp/delete",appid=$scope.prepareReleaseApp.appleId;$http.post(searchUrl,{appid:appid}).success(function(response){if(0==response.errorId){console.log("remove app if");for(var i=0;i<$scope.myApps.length;i++){var app=$scope.myApps[i];if(app.appleId==appid){$scope.myApps.splice(i,1),refreshAddBtn();break}}}else $scope.errorMsg=response.errorMsg;$scope.appResults=[],$scope.numOfApps--,0==$scope.numOfApps?($scope.selectedApp=void 0,getDemand()):$scope.prepareReleaseApp==$scope.selectedApp&&($scope.selectedApp=$scope.myApps[0],$scope.isDisabled=!1,getDemand())})},$scope.buttonCheck=!0;var index=3;addInput=function(){document.getElementById("inputTagsOne").innerHTML+='<div id="div_'+index+'"><input name="text" name="text_'+index+'" type="text" value=""  /><input type="button" value="删除"  onclick="del('+index+')"/></div>',index+=1},$scope.change=!1,$scope.radio=function(curre){1==document.getElementById("optionsRadios1").checked?$scope.change=!0:$scope.change=!1},$scope.Confirm=function(){},$scope.color={color:"#3498db","font-size":"14px"},$scope.canSendTask=function(){"小马"==$scope.displayDemandTemplate.sendPlatform&&void 0!=$scope.displayDemandTemplate.customTaskType||void 0!=$scope.displayDemandTemplate.ranKing||$scope.displayDemandTemplate.ranKing<200?releaseTask():(void 0==$scope.displayDemandTemplate.ranKing||$scope.displayDemandTemplate.ranKing>200)&&($scope.errorMsg="排名无效(需在1-200之间,含200)",$("#releaseTaskApp2").modal("toggle"))},closefun=function(response){$("#myButton");document.taskInfo.action="/myapp/task",document.taskInfo.submit(),$("#releaseTaskApp1").modal("hide")},$scope.needGetCheck=function($event){var checkbox=$event.target;$scope.displayDemandTemplate.detailRem.indexOf("获取")!=-1&&($scope.displayDemandTemplate.needGet=!0,toastr.error("备注中有获取字样,无法取消,请先修改备注"),checkbox.checked=!0),$scope.calYCoin()},$scope.registerMethod=function(registerStyle){$scope.displayDemandTemplate.registerStatus=registerStyle,$scope.calYCoin(),moneyCheck()},$scope.commentOver50=function($event){$event.target;$scope.calYCoin()},$scope.calYCoin=function(){function screenShotOneElement(){displayDemandTemplate.ranKing>=41&&displayDemandTemplate.ranKing<=50?(displayDemandTemplate.excUnitPrice+=1,$scope.rankExtraYCoin=1):displayDemandTemplate.ranKing>50?($scope.rankExtraYCoin=Math.ceil(1+.5*(displayDemandTemplate.ranKing-50)),displayDemandTemplate.excUnitPrice+=$scope.rankExtraYCoin):$scope.rankExtraYCoin=0,1==displayDemandTemplate.needGet&&(displayDemandTemplate.excUnitPrice+=5)}function screenShotTwoElement(){"third"==displayDemandTemplate.registerStatus&&(displayDemandTemplate.excUnitPrice+=2)}function screenShotThirdElement(){void 0!=displayDemandTemplate.reviewMustTitleKey&&""!=displayDemandTemplate.reviewMustTitleKey?(displayDemandTemplate.excUnitPrice+=1,$scope.mustTitleExtraYB=1):$scope.mustTitleExtraYB=0,void 0!=displayDemandTemplate.reviewMustContentKey&&""!=displayDemandTemplate.reviewMustContentKey?(displayDemandTemplate.excUnitPrice+=1,$scope.mustContentExtraYB=1):$scope.mustContentExtraYB=0,1==displayDemandTemplate.needMoreReviewContent&&(displayDemandTemplate.excUnitPrice+=3)}var displayDemandTemplate=$scope.displayDemandTemplate;if(void 0!=displayDemandTemplate){"评论"==displayDemandTemplate.taskType?displayDemandTemplate.excUnitPrice=30:displayDemandTemplate.excUnitPrice=20;var appPriceStr=$scope.selectedApp.formattedPrice,appPrice=parseFloat(appPriceStr.substring(1,appPriceStr.length));"免费"!=appPriceStr&&(displayDemandTemplate.needGet=!0,displayDemandTemplate.excUnitPrice+=15*appPrice),screenShotOneElement(),screenShotTwoElement(),"评论"==displayDemandTemplate.taskType&&screenShotThirdElement(),moneyCheck()}},$scope.remarkChange=function(){void 0!=$scope.displayDemandTemplate.detailRem&&$scope.displayDemandTemplate.detailRem.indexOf("获取")!=-1&&($scope.displayDemandTemplate.needGet=!0,toastr.warning("需求获取(首次下载),+5Y币")),$scope.calYCoin()},$scope.focuskey=function(){$scope.getAsoRanking=-1},$scope.getAsoRanking=-1,$scope.getKeyAsoRank=function(){var url="myapp/asoRank";1!=$scope.getAsoRanking&&void 0!=$scope.displayDemandTemplate.searchKeyword&&0!=$scope.displayDemandTemplate.searchKeyword.length&&($scope.getAsoRanking=1,$scope.displayDemandTemplate.ranKingErrorMsg=void 0,$http.post(url,{asoWord:$scope.displayDemandTemplate.searchKeyword,appleId:$scope.selectedApp.appleId}).success(function(response){0==response.errorId?($scope.displayDemandTemplate.ranKing=response.asoKeyRank,$scope.displayDemandTemplate.ranKingErrorMsg=void 0,$scope.calYCoin()):($scope.displayDemandTemplate.ranKing=999,$scope.displayDemandTemplate.ranKingErrorMsg=response.errorMsg,toastr.error(response.errorMsg))}).error(function(){toastr.error("未找到该词")}).finally(function(){$scope.getAsoRanking=0}))},$scope.addApp=function(id){"glyphicon"==id?$("#"+id).popover("toggle"):$("#"+id).popover("toggle")};var heightOfNav=51,height=$(window).innerHeight()-heightOfNav;$scope.shadow=!0,console.log(height),$.fn.smartFloat=function(){var position=function(element){$(window).scroll(function(){var scrolls=$(window).scrollTop();scrolls>330||void 0==scrolls?($scope.shadow=!1,window.XMLHttpRequest?($scope.shadow=!0,element.css({position:"fixed",top:50,"box-shadow":"0 2px 5px #b2b2b2"})):element.css({top:scrolls,"box-shadow":"0 0 0"})):element.css({position:"relative",top:0,"box-shadow":"0 0 0"})})};return $(this).each(function(){position($(this))})},$("#float").smartFloat(),$scope.addModal=function(){$(".ui.modal").modal("show")},$(".small.test.modal").modal("show")});