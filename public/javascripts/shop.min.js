var app=angular.module("yemaWebApp",[]),navIndex=5;app.filter("startFrom",function(){return function(inputArray,start){if(void 0==inputArray)return[];for(var array=[],i=start;i<inputArray.length;i++)array.push(inputArray[i]);return array}}),app.controller("shopCtrl",function($scope,$http,$location,$q){function resetShopAsoBuy(){$scope.shopASOBuyObject={},$scope.shopASOBuyObject.limitRanking=500,$scope.selectedTaskCountPerDay=0,$scope.shopASOBuyObject.taskCountPerDay=$scope.taskCountPerDayBatch[0]}function calTaskPerPrice(){var taskType=$scope.shopASOBuyObject.taskType;"下载"==taskType?$scope.shopASOBuyObject.taskPrice=2.2:"评论"==taskType&&($scope.shopASOBuyObject.taskPrice=2.8),$scope.shopASOBuyObject.rankPriceString="";var asoKeyRank=$scope.shopASOBuyObject.ranKing;asoKeyRank>100?asoKeyRank>100&&(asoKeyRank<=500&&asoKeyRank>=400?($scope.shopASOBuyObject.taskRankPrice=.6+.035*($scope.shopASOBuyObject.ranKing-100),$scope.shopASOBuyObject.taskPrice+=$scope.shopASOBuyObject.taskRankPrice,$scope.shopASOBuyObject.rankPriceString="100-500名:0.6+(0.035元*额外排名)/条"):asoKeyRank<400&&asoKeyRank>=300?($scope.shopASOBuyObject.taskRankPrice=.6+.032*($scope.shopASOBuyObject.ranKing-100),$scope.shopASOBuyObject.taskPrice+=$scope.shopASOBuyObject.taskRankPrice,$scope.shopASOBuyObject.rankPriceString="100-400名:0.6+(0.032元*额外排名)/条"):asoKeyRank<300&&asoKeyRank>=200?($scope.shopASOBuyObject.taskRankPrice=.6+.03*($scope.shopASOBuyObject.ranKing-100),$scope.shopASOBuyObject.taskPrice+=$scope.shopASOBuyObject.taskRankPrice,$scope.shopASOBuyObject.rankPriceString="100-300名:0.6+(0.03元*额外排名)/条"):asoKeyRank<200&&($scope.shopASOBuyObject.taskRankPrice=.6+.02*($scope.shopASOBuyObject.ranKing-100),$scope.shopASOBuyObject.taskPrice+=$scope.shopASOBuyObject.taskRankPrice,$scope.shopASOBuyObject.rankPriceString="100-200名:0.6+(0.02元*额外排名)/条")):$scope.shopASOBuyObject.ranKing>40&&($scope.shopASOBuyObject.taskRankPrice=.01*($scope.shopASOBuyObject.ranKing-40),$scope.shopASOBuyObject.taskPrice+=$scope.shopASOBuyObject.taskRankPrice,$scope.shopASOBuyObject.rankPriceString="40-100名:+(0.01元*额外排名)/条"),"needThird"==$scope.shopASOBuyObject.needThird&&($scope.shopASOBuyObject.taskPrice+=.2),"formalCheck"==$scope.shopASOBuyObject.formalCheck&&($scope.shopASOBuyObject.taskPrice+=.1),"needGet"==$scope.shopASOBuyObject.needGet&&($scope.shopASOBuyObject.taskPrice+=.1),"评论"==taskType&&"comment4G"==$scope.shopASOBuyObject.comment4G&&($scope.shopASOBuyObject.taskPrice+=.1),1!=$scope.existDiscount&&"timer"==$scope.shopASOBuyObject.sendType&&"下载"==$scope.shopASOBuyObject.taskType&&"formalCheck"==$scope.shopASOBuyObject.formalCheck&&$scope.shopASOBuyObject.taskLastDay>=3&&$scope.shopASOBuyObject.taskCountPerDay>=30&&$scope.shopASOBuyObject.taskCountPerDay<=50&&$scope.shopASOBuyObject.ranKing>=100&&$scope.shopASOBuyObject.ranKing<=200&&(toastr.info("已经满足双十一活动5折优惠条件，你看到的价格都已经是6折的价格!"),$scope.shopASOBuyObject.calculateFavNum=6,$scope.shopASOBuyObject.taskPrice=$scope.shopASOBuyObject.taskPrice*($scope.shopASOBuyObject.calculateFavNum/10))}function dealTaskCountPerDay(){for(var count=$scope.shopASOBuyObject.taskCountPerDay,flag=!1,i=0;i<$scope.taskCountPerDayBatch.length;i++)if($scope.taskCountPerDayBatch[i]==count){$scope.selectedTaskCountPerDay=i,flag=!0;break}0==flag&&($scope.shopASOBuyObject.customDay=$scope.shopASOBuyObject.taskCountPerDay,$scope.customTaskCountPerDay())}$scope.asoPlantTitle="开始创建你的投放方案",$scope.isShowAsoAdvice=!1,$scope.ASOHelpString="查看ASO选词/优化建议",$scope.lookASOHelp=function(){$scope.isShowAsoAdvice=!$scope.isShowAsoAdvice,1==$scope.isShowAsoAdvice?$scope.ASOHelpString="隐藏ASO优化建议":$scope.ASOHelpString="查看ASO选词/优化建议"},$scope.ASOPlanArray=[];var userPlansUrl="/shop/getUserPlans";$http.get(userPlansUrl).success(function(response){0==response.errorId?($scope.ASOPlanArray=response.ASOPlanArray,$scope.existDiscount=response.existDiscount):toastr.error(response.message)}),$scope.taskCountPerDayBatch=[10,50,100,200,500],$scope.selectedTaskCountPerDay=0,$scope.shopASOBuyObject=Object(),resetShopAsoBuy(),$scope.isLockPlan=!1,$scope.buy1111Download=function(){$scope.isLockPlan=!0,$scope.asoPlantTitle="请先选择你要投放的App",$scope.taskCountPerDayBatch=[1111],$scope.selectedTaskCountPerDay=0,$scope.shopASOBuyObject.taskCountPerDay=1111,$scope.taskLastDays=[1],$scope.shopASOBuyObject.limitRanking=1111,$scope.shopASOBuyObject.taskType="下载",$scope.shopASOBuyObject.needGet="needGet",$scope.shopASOBuyObject.price=1888,$scope.shopASOBuyObject.ranKing>$scope.shopASOBuyObject.limitRanking?($scope.ranKingErrorMsg="关键词排名超出方案限制!",toastr.error("关键词排名超出方案限制!")):toastr.info("请先选择你要投放的App"),$scope.taskExtraDemand("needThird"),$scope.taskExtraDemand("formalCheck")},$scope.clickRecharge=0,$scope.prepareRechargeCash=function(){$scope.clickRecharge=!$scope.clickRecharge};var userPointerUrl="/shop/userPointer";$scope.userPointer="??",$http.get(userPointerUrl).success(function(response){0==response.errorId?($scope.userPointer=response.userPointer,$scope.cashMoney=response.cashMoney):toastr.error(response.message)}),$scope.pointerItems=[];for(var pointers=[100,300,500,1e3],i=0;i<pointers.length;i++){var pointerItem={};pointerItem.pointer=pointers[i],pointerItem.icon="/images/shop/"+parseInt(pointerItem.pointer/100)+".png",pointerItem.title=pointerItem.pointer/10+"元现金券",pointerItem.des=pointerItem.pointer+"积分",$scope.pointerItems.push(pointerItem)}$scope.exchange=function(pointer){if(pointer>$scope.userPointer)return void toastr.error("积分不足");var userYCoinGoodsUrl="/shop/pointerBuyer";$http.post(userYCoinGoodsUrl,{consumePointer:pointer}).success(function(response){0!=response.errorId?toastr.error(response.message):($scope.cashMoney+=response.addCash,$scope.userPointer-=pointer,toastr.success(response.message))})};var asoRefineGoodUrl="/shop/asoHistory";$scope.shopASOGoods=[],$scope.selectedAppASOGoodKeys=[],$http.get(asoRefineGoodUrl).success(function(response){0!=response.errorId?toastr.error(response.message):($scope.shopASOGoods=response.shopASOGoods,response.shopASOGoods.length>0&&$scope.selectMyApp(0))}),$scope.selectMyApp=function(selectedAppIndex){$scope.selectedAppASOGoodKeys=$scope.shopASOGoods[selectedAppIndex].asoKeys;var appInfo=$scope.shopASOGoods[selectedAppIndex];void 0!=$scope.shopASOBuyObject.trackName&&$scope.shopASOBuyObject.trackName!=appInfo.trackName&&resetShopAsoBuy(),$scope.shopASOBuyObject.appleId=$scope.shopASOGoods[selectedAppIndex].appleId,$scope.shopASOBuyObject.trackName=$scope.shopASOGoods[selectedAppIndex].trackName,$scope.shopASOBuyObject.artworkUrl100=$scope.shopASOGoods[selectedAppIndex].artworkUrl100,$scope.shopASOBuyObject.artworkUrl512=$scope.shopASOGoods[selectedAppIndex].artworkUrl512,$scope.shopASOBuyObject.appObjectId=$scope.shopASOGoods[selectedAppIndex].appObjectId,$scope.selectedAppASOGoodKeys.length>0&&($scope.shopASOBuyObject.asoKey=$scope.selectedAppASOGoodKeys[0],$scope.getKeyAsoRank())},$scope.selectNewAsoKey=function(keyIndex){$scope.shopASOBuyObject.asoKey=$scope.selectedAppASOGoodKeys[keyIndex],$scope.getKeyAsoRank()},$scope.getAsoRanking=-1,$scope.rankedAsoKey=void 0,$scope.rankedAppleId=void 0;var asoRankCanceler=$q.defer();$scope.getKeyAsoRank=function(){var url="myapp/asoRank";void 0!=$scope.shopASOBuyObject.asoKey&&0!=$scope.shopASOBuyObject.asoKey.length&&($scope.rankedAppleId==$scope.shopASOBuyObject.rankedAppleId&&$scope.rankedAsoKey==$scope.shopASOBuyObject.asoKey&&$scope.shopASOBuyObject.ranKing<500||(1==$scope.getAsoRanking&&asoRankCanceler.resolve(),$scope.getAsoRanking=1,$scope.ranKingErrorMsg=void 0,$scope.rankedAppleId=$scope.shopASOBuyObject.appleId,$scope.rankedAsoKey=$scope.shopASOBuyObject.asoKey,$http.post(url,{asoWord:$scope.shopASOBuyObject.asoKey,appleId:$scope.shopASOBuyObject.appleId,maxASOKey:$scope.shopASOBuyObject.limitRanking,timeout:asoRankCanceler.promise}).success(function(response){0==response.errorId?response.rankedAppleId==$scope.rankedAppleId&&($scope.shopASOBuyObject.ranKing=response.asoKeyRank,$scope.ranKing>$scope.shopASOBuyObject.limitRanking?$scope.ranKingErrorMsg="关键词排名超出方案限制!":calTaskPerPrice()):response.rankedAppleId==$scope.rankedAppleId&&($scope.shopASOBuyObject.ranKing=999,$scope.ranKingErrorMsg=response.errorMsg,toastr.error(response.errorMsg))}).error(function(){toastr.error("网络异常")}).finally(function(){$scope.getAsoRanking=0})))},$scope.addNewAsoKey=function(e){var keyCode=window.event?e.keyCode:e.which;13==keyCode&&($scope.selectedAppASOGoodKeys.unshift($scope.newSelectedAppAsoKey),$scope.shopASOBuyObject.asoKey=$scope.newSelectedAppAsoKey,$scope.newSelectedAppAsoKey="",$scope.getKeyAsoRank())},$scope.isShopAddApp=!1,$scope.shopAddApp=function(searchAppIndex){var appInfo=$scope.searchApps[searchAppIndex],shopAddAppUrl="myapp/shopAddApp";return 1==$scope.isShopAddApp?void toastr.info("稍等,在录入您的App信息"):($scope.isShopAddApp=!0,void $http.post(shopAddAppUrl,{appInfo:appInfo}).success(function(response){0==response.errorId?($scope.selectedAppASOGoodKeys=[],void 0!=$scope.shopASOBuyObject.trackName&&$scope.shopASOBuyObject.trackName!=appInfo.trackName&&resetShopAsoBuy(),$scope.shopASOBuyObject.appleId=appInfo.appleId,$scope.shopASOBuyObject.trackName=appInfo.trackName,$scope.shopASOBuyObject.artworkUrl100=appInfo.artworkUrl100,$scope.shopASOBuyObject.artworkUrl512=appInfo.artworkUrl512,$scope.shopASOBuyObject.appObjectId=response.appObjectId):toastr.error(response.message)}).error(function(){toastr.error("网络异常")}).finally(function(){$scope.isShopAddApp=!1}))},$scope.isSearchApps=!1,$scope.searchAppKeyword=void 0,$scope.searchNewApps=function(e){var keyCode=window.event?e.keyCode:e.which;if(13==keyCode){if(void 0==$scope.searchAppKeyword||0==$scope.searchAppKeyword.length)return;if(1==$scope.isSearchApps)return void toastr.info("正在搜索名为 "+$scope.searchAppKeyword+" 的App");$scope.searchApps=[],$scope.isSearchApps=!0;var searchUrl="api/itunes/search/"+$scope.searchAppKeyword;$scope.progressNum=100,console.log("--------- searchApp searchApp"),$http.get(searchUrl).success(function(response){if(console.log("searchApp"+response),$scope.searchApps=response.appResults,$scope.progressNum=0,response.errorMsg.length>0)$scope.isError=1,$scope.errorMsg=response.errorMsg;else{$scope.errorMsg=response.errorMsg,$scope.isError=0!=response.errorId;for(var i=0;i<response.appResults.length;i++){var appRe=response.appResults[i];appRe.isMine=!1;for(var j=0;j<$scope.shopASOGoods.length;j++){var myApp=$scope.shopASOGoods[j];if(myApp.appleId===appRe.appleId){appRe.isMine=!0;break}}"免费"!=appRe.formattedPrice&&(appRe.isMine=!0),0==appRe.isMine}}}).finally(function(){$scope.isSearchApps=!1})}},$scope.shopASOBuyObject.taskType="下载",$scope.shopASOBuyObject.needGet="needGet",$scope.shopASOBuyObject.taskCountPerDay=$scope.taskCountPerDayBatch[0],$scope.shopTaskType=function(type){$scope.shopASOBuyObject.taskType=type,calTaskPerPrice()},$scope.shopSendTaskType=function(type){$scope.shopASOBuyObject.sendType=type},$scope.taskCountPerDayAction=function(selectedIndex){$scope.selectedTaskCountPerDay=selectedIndex,$scope.shopASOBuyObject.taskCountPerDay=$scope.taskCountPerDayBatch[selectedIndex],calTaskPerPrice()};var isCustomTaskPerDay=!1;$scope.customTaskCountPerDay=function(){1==isCustomTaskPerDay&&$scope.taskCountPerDayBatch.shift(),isCustomTaskPerDay=!0,$scope.taskCountPerDayBatch.unshift($scope.shopASOBuyObject.customDay),$scope.selectedTaskCountPerDay=0,$scope.shopASOBuyObject.taskCountPerDay=$scope.shopASOBuyObject.customDay,calTaskPerPrice()},$scope.taskExtraDemand=function(extraDemandId,e){var isCheck=void 0==e||e.currentTarget.checked;"needThird"==extraDemandId?$scope.shopASOBuyObject.needThird=1==isCheck?extraDemandId:void 0:"formalCheck"==extraDemandId?$scope.shopASOBuyObject.formalCheck=1==isCheck?extraDemandId:void 0:"needGet"==extraDemandId?$scope.shopASOBuyObject.needGet=1==isCheck?extraDemandId:void 0:"comment4G"==extraDemandId&&($scope.shopASOBuyObject.comment4G=1==isCheck?extraDemandId:void 0),calTaskPerPrice()},$scope.createAsoPlanLoading=!0,$scope.createAsoPlan=function(){if($scope.createAsoPlanLoading=!1,void 0==$scope.shopASOBuyObject.planName||""==$scope.shopASOBuyObject.planName)return $scope.createAsoPlanLoading=!0,void toastr.error("还没有为你的投放方案取名哦");if(void 0==$scope.shopASOBuyObject.taskType)return $scope.createAsoPlanLoading=!0,void toastr.error("请选择任务类型");if(void 0==$scope.shopASOBuyObject.ranKing||$scope.shopASOBuyObject.ranKing>500)return $scope.createAsoPlanLoading=!0,void toastr.error("关键词排名获取中，请稍等/或者排名超过了"+$scope.shopASOBuyObject.limitRanking+"名");if(void 0==$scope.shopASOBuyObject.appObjectId||""==$scope.shopASOBuyObject.appObjectId)return $scope.createAsoPlanLoading=!0,void toastr.error("未成功选择App");if("now"!=$scope.shopASOBuyObject.sendType&&"timer"!=$scope.shopASOBuyObject.sendType)return $scope.createAsoPlanLoading=!0,void toastr.error("未选择投放方式(立即投放/定时投放)");if("评论"==$scope.shopASOBuyObject.taskType){if(void 0==$scope.shopASOBuyObject.commentKeys||""==$scope.shopASOBuyObject.commentKeys)return $scope.createAsoPlanLoading=!0,void toastr.error("评论标题关键词未填写");if(void 0==$scope.shopASOBuyObject.commentContentKeys||""==$scope.shopASOBuyObject.commentContentKeys)return $scope.createAsoPlanLoading=!0,void toastr.error("评论内容关键词未填写")}var tempASORanking=$scope.shopASOBuyObject.ranKing,tempPerDayCount=$scope.shopASOBuyObject.taskCountPerDay;if(tempASORanking>200){if(tempPerDayCount<30)return $scope.createAsoPlanLoading=!0,void toastr.info("关键词排名>200时单次投放量低于30是基本无效的，建议修改量级")}else if(tempASORanking>100&&tempPerDayCount<20)return $scope.createAsoPlanLoading=!0,void toastr.info("关键词排名>100时单次投放量低于20是基本无效的，建议修改量级");var createAsoPlanURL="/shop/createPlan";$http.post(createAsoPlanURL,{createAsoPlanInfo:$scope.shopASOBuyObject}).success(function(response){if(0==response.errorId){resetShopAsoBuy();for(var existIndex=-1,i=0;i<$scope.ASOPlanArray.length;i++)if($scope.ASOPlanArray[i].planId==response.createdAsoPlan.planId){existIndex=i;break}existIndex==-1?$scope.ASOPlanArray.push(response.createdAsoPlan):($scope.ASOPlanArray.splice(existIndex,1),$scope.ASOPlanArray.unshift(response.createdAsoPlan)),toastr.success(response.message,{timeOut:2e3})}else toastr.error(response.message,{timeOut:3e3})}).finally(function(){$scope.createAsoPlanLoading=!0})},$scope.selectTaskHour=function(taskHour){$scope.shopASOBuyObject.taskHour=taskHour},$scope.shopASOBuyObject.taskHour=15,$scope.taskLastDays=[1,2,3,4,5,6,7,8,9,10],$scope.selectTaskLastDay=function(taskLastDay){$scope.shopASOBuyObject.taskLastDay=taskLastDay,calTaskPerPrice()},$scope.shopASOBuyObject.taskLastDay=$scope.taskLastDays[0],$scope.selectDelayTaskDay=function(delayTaskDay){$scope.shopASOBuyObject.delayTaskDay=delayTaskDay},$scope.shopASOBuyObject.delayTaskDay=0,$scope.taskExtraDemand("formalCheck"),calTaskPerPrice(),$scope.modifyPlan=function(planIndex){$scope.shopASOBuyObject=$scope.ASOPlanArray[planIndex],$scope.shopASOBuyObject.limitRanking=500,dealTaskCountPerDay(),$scope.getKeyAsoRank(),calTaskPerPrice()},$scope.actionPlan=function(planIndex,actionId){$scope.ASOPlanArray[planIndex].actionId=actionId;var createAsoPlanURL="/shop/createPlan";$http.post(createAsoPlanURL,{createAsoPlanInfo:$scope.ASOPlanArray[planIndex]}).success(function(response){0==response.errorId?("stop"==actionId||"restart"==actionId?toastr.success(response.message,{timeOut:2e3}):"hidden"==actionId?toastr.success("下次进入该界面，将不在显示该计划",{timeOut:2e3}):toastr.success(response.message,{timeOut:2e3}),$scope.ASOPlanArray[planIndex].planStatus=actionId):toastr.error(response.message,{timeOut:3e3})})},$scope.copyPlan=function(planIndex){var selectToCopyPlanObject=$scope.ASOPlanArray[planIndex];$scope.shopASOBuyObject={},$.extend($scope.shopASOBuyObject,selectToCopyPlanObject),$scope.shopASOBuyObject.planId=void 0,$scope.shopASOBuyObject.limitRanking=500,dealTaskCountPerDay(),$scope.getKeyAsoRank(),calTaskPerPrice()},$scope.isLoadingApp=!0,$scope.updateApp=function(appObjectId){$scope.isLoadingApp=!1,$scope.errorMsg="";var updateAppURL="/myapp/UpdateApp";$http.post(updateAppURL,{appObjectId:appObjectId}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,0==response.errorId?($scope.errorMsg=response.errorMsg,$scope.isLoadingApp=!0,$scope.appObjectId=appObjectId,toastr.success(response.errorMsg,{timeOut:2e3})):toastr.error(response.errorMsg)})}});