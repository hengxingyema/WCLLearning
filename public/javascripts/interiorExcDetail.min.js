var app=angular.module("yemaWebApp",[]),navIndex=3;app.directive("onRepeatFinishedRender",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.$last===!0&&$timeout(function(){scope.$emit("ngRepeatFinished",element)})}}}),app.controller("interorDetailControl",function($scope,$http,$location){function addFilesToScope(fileIndex,files){var maxFileNum;maxFileNum="下载"==$scope.oneAppInfo.excKinds?3:"评论"==$scope.oneAppInfo.excKinds?3:5;var innerScope=angular.element(".page-wrapper").scope(),mackTask=innerScope.macTasks[fileIndex];if(""!=mackTask.status)return void toastr.info("请先点击重新上传按钮");void 0==mackTask.files?mackTask.files=files:mackTask.files=mackTask.files.concat(files);var fileLength=mackTask.files.length;if(fileLength>maxFileNum)for(var si=0;si<fileLength-maxFileNum;si++)mackTask.files.shift();mackTask.localTaskImgs=[];for(var i=0;i<mackTask.files.length;i++){var tempFile=mackTask.files[i],reader=new FileReader;reader.onload=function(e){void 0==mackTask.localTaskImgs&&(mackTask.localTaskImgs=[]),mackTask.localTaskImgs.push(e.target.result),innerScope.$apply()},reader.readAsDataURL(tempFile)}}function prepareUploadCtrol(){$(".fileupload").each(function(index){$(this).fileupload({dataType:"json",dropZone:$(this),drop:function(e,data){addFilesToScope(index,data.files)},change:function(e,data){addFilesToScope(index,data.files)},add:function(e,data){},done:function(e,data){},progressall:function(e,data){var innerScope=angular.element(".page-wrapper").scope(),progress=.9*parseInt(data.loaded/data.total*100,10),mackTask=innerScope.macTasks[index];mackTask.uploadProgress=progress,innerScope.$apply()}}),""==$scope.macTasks[index].status?$(this).fileupload("enable"):$(this).fileupload("disable")})}var appurlList=$location.absUrl().split("/"),excTaskId=appurlList[appurlList.length-1],Url="interior/"+excTaskId,existTaskNum=0;$http.get(Url).success(function(response){if(0==response.errorId){$scope.oneAppInfo=response.oneAppInfo;for(var i=0;i<response.macTasks.length;i++)"uploaded"==response.macTasks[i].status||"reUploaded"==response.macTasks[i].status?(existTaskNum++,response.macTasks[i].status="待审核"):"rejected"==response.macTasks[i].status||"refused"==response.macTasks[i].status?(existTaskNum++,response.macTasks[i].status="被拒绝"):"accepted"==response.macTasks[i].status||"systemAccepted"==response.macTasks[i].status?(existTaskNum++,response.macTasks[i].status="已完成"):"expired"==response.macTasks[i].status||(response.macTasks[i].status=""),$scope.macTasks=response.macTasks;$scope.nextTaskNum=$scope.oneAppInfo.totalExcCount-$scope.oneAppInfo.tasksRemain+1}}),$scope.prepareRevoke=function(task){$scope.revokedTask=task},$scope.userSubmitRevoke=function(task,revokeReason,$event){var btn=$event.target;btn.disabled=!0;var url="/interiorExcDetail/revoke";$http.post(url,{receiveTaskId:task.receiveTaskId,mackTaskId:task.mackTaskId,revokeReason:revokeReason}).success(function(response){0==response.errorId?(btn.disabled=!1,$("#myModal").modal("hide"),task.revokeStatus="revokeUploaded",toastr.success("已提交申诉,野马客服会尽快处理",{timeOut:2e3})):toastr.error("申诉失败,网络异常")})},$scope.prepareUploadImgs=function(task,reUploadIndex){$(".fileupload").each(function(index){reUploadIndex==index&&(console.log("file reUpload index:",index),$(this).fileupload("enable"))}),task.isUploading=0,task.revokeStatus="",task.dealInfo="",task.detail="",task.status="",task.taskImages=[]},$scope.$on("ngRepeatFinished",function(repeatFinishedEvent,element){prepareUploadCtrol(),$(document).bind("dragover",function(e){var foundDropzone,dropZone=$(".dropzone"),timeout=window.dropZoneTimeout;timeout?clearTimeout(timeout):dropZone.addClass("in");var found=!1,node=e.target;do{if($(node).hasClass("dropzone")){found=!0,foundDropzone=$(node);break}node=node.parentNode}while(null!=node);dropZone.removeClass("in hover"),found&&foundDropzone.addClass("hover"),window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null,dropZone.removeClass("in hover")},100)})}),$scope.mackTaskId=void 0,$scope.uploadFiles=function(index,$event){var mackTask=$scope.macTasks[index];return mackTask.isUploading=1,void 0==mackTask.files||0==mackTask.files.length?void toastr.warning("请先选择图片"):($event.target.disabled=!0,$event.target.innerText="上传中",void $(".fileupload").each(function(fileUploadIndex){if(fileUploadIndex==index){console.log("file uploading fileUploadIndex:",fileUploadIndex);$(this).fileupload("send",{files:mackTask.files}).success(function(result,textStatus,jqXHR){var responseObject=$.parseJSON(jqXHR.responseText);console.log("file uploading success:",responseObject);var url="/interiorExcDetail/add/"+excTaskId;mackTask.uploadProgress=90;var name=mackTask.uploadName;void 0!=name&&0!=name.length||(name="批量传图"+(existTaskNum+1)),$http.post(url,{uploadName:name,requirementImgs:responseObject.files}).success(function(response){mackTask.uploadProgress=100,existTaskNum++,0==response.errorId?(mackTask.status="待审核",mackTask.taskImages=responseObject.files,toastr.success(responseObject.files.length+"张图片上传成功",{timeOut:2e3}),mackTask.localTaskImgs=[],mackTask.files=[],$scope.mackTaskId=response.mackTaskId,$event.target.innerText="上传成功"):(toastr.error("上传图片失败 : "+response.errorMsg),$event.target.disabled=!1,$event.target.innerText="重新上传")}).error(function(error){toastr.error("上传图片失败 : "+error.message),$event.target.disabled=!1,$event.target.innerText="重新上传"})}).error(function(jqXHR,textStatus,errorThrown){mackTask.errorId=-1,toastr.error("上传图片失败 : "+errorThrown),"abort"===errorThrown&&alert("File Upload has been canceled"),$event.target.disabled=!1,$event.target.innerText="重新上传"}).complete(function(result,textStatus,jqXHR){console.log("file uploading complete:",jqXHR),mackTask.isUploading=0,mackTask.uploadProgress=0})}}))},$(document).bind("drop dragover",function(e){e.preventDefault()}),$scope.commitConfirm=function(){location.href="/myClaim/"+$scope.oneAppInfo.userObjectId},$scope.openNewPage=function(courseid){location.href="/interiorExcDetail/"+courseid},$scope.reAssign=function(task){task.mode=!0,console.log("changed")},$scope.submitMsg=function(submitMsg,mackTaskId,task){var submitMsgURL="/interiorExcDetail/submitMsg";$scope.mackTaskID="",void 0==mackTaskId?$scope.mackTaskID=$scope.mackTaskId:$scope.mackTaskID=mackTaskId,$http.post(submitMsgURL,{submitMsg:submitMsg,mackTaskId:$scope.mackTaskID}).success(function(response){0==response.errorId?(toastr.success("留言成功",{timeOut:2e3}),task.mode=!1):toastr.error("留言失败 : "+response.errorMsg)})}});