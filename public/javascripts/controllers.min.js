function getUserCode(){gUserCId=window.localStorage?localStorage.getItem("userCId"):getCookie("userCId")}var gUserCId,interval=1e3;angular.module("starter.controllers",["angularFileUpload"]).controller("homeController",function($scope,$http,$location,$ionicPopup,$timeout,$ionicLoading){var homeUrlList=$location.absUrl().split("/"),inviteCode=homeUrlList[homeUrlList.length-1];if(getUserCode(),$scope.isIOSDevice=0,$scope.isAndroidDevice=0,/(iPhone|iPad|iPod|iOS|MacIntel|Macintosh)/i.test(navigator.userAgent)?$scope.isIOSDevice=1:/android/i.test(navigator.userAgent)&&($scope.isAndroidDevice=1),$scope.isQQBrowser=0,$scope.isWeixinBrowser=0,$scope.isiPhoneSafari=0,($scope.isAndroid||$scope.isIOSDevice)&&(/QQ/i.test(navigator.userAgent)?$scope.isQQBrowser=1:/MicroMessenger/i.test(navigator.userAgent)?$scope.isWeixinBrowser=1:/Safari/i.test(navigator.userAgent)&&($scope.isiPhoneSafari=1)),1==$scope.isIOSDevice&&1==$scope.isiPhoneSafari){$ionicLoading.show();try{localStorage.setItem("testSafariMode","xiaomaTest")}catch(e){return $ionicLoading.hide(),void alert("无痕模式无法正常使用小马哦,点击右下角后,再点击左下角关闭无痕模式")}$scope.refreshHome=function(isRefresh){var userInfoUrl="/taskUser/"+gUserCId+"/"+inviteCode;$http.get(userInfoUrl).success(function(response){if(0==response.errorId){if(window.localStorage)try{localStorage.setItem("userCId",response.userInfoObject.userCId),localStorage.setItem("userCode",response.userInfoObject.userCode)}catch(e){return void alert("无痕模式无法正常使用小马哦,点击【Safari工具栏右下角】按钮后,再点【新工具栏击左下角】按钮，从而关闭无痕模式")}else setCookie("userCId",response.userInfoObject.userCId),setCookie("userCode",response.userInfoObject.userCode);"home"!=inviteCode?$scope.inviteUrl=$location.absUrl().substring(0,$location.absUrl().length-inviteCode.length-1)+"/"+response.userInfoObject.userCode:$scope.inviteUrl=$location.absUrl()+"/"+response.userInfoObject.userCode,$scope.userInfoObject=response.userInfoObject,$scope.masterConfig=response.masterConfig}else $scope.errorId=response.errorId,$scope.message=response.message}).finally(function(){$ionicLoading.hide(),1==isRefresh&&$scope.$broadcast("scroll.refreshComplete")})},$scope.refreshHome(0),$scope.showAlert=function(){var myPopup=$ionicPopup.show({title:"师傅的邀请码错误"});$timeout(function(){myPopup.close()},1e3)};var bindLock=0;$scope.ctrlScope=$scope,$scope.bindMaster=function(){if(1!=bindLock&&void 0!=$scope.ctrlScope.inputMasterCode&&0!=$scope.ctrlScope.inputMasterCode.length){var bindUrl="/taskUser/bindMaster",bindParams={userCode:$scope.userInfoObject.userCode,masterCode:$scope.ctrlScope.inputMasterCode};bindLock=1,$ionicLoading.show(),$http.post(bindUrl,bindParams).success(function(response){$ionicLoading.hide(),bindLock=0,0==response.errorId?$scope.masterCode=$scope.ctrlScope.inputMasterCode:$scope.showAlert()})}},$scope.becomeMaketingPeople=function(){var bindUrl="/taskUser/becomeMarketingUser",bindParams={userCId:$scope.userInfoObject.userCId};$ionicLoading.show(),$http.post(bindUrl,bindParams).success(function(response){$ionicLoading.hide(),bindLock=0,0==response.errorId?($scope.errorId=response.errorId,toastr.success("成功成为推广大使")):(toastr.error(response.message),$scope.showAlertError(response.message))})},$scope.unselectUrl=function(){try{document.execCommand("Unselect")}catch(e){alert(e)}}}}).controller("TaskHallController",function($scope,$http,$ionicFilterBar,$timeout,$ionicLoading){getUserCode();var pageCount=20;$scope.taskClick=function(clickTask){window.location.href="/app#/tab/task/"+clickTask.taskId},$scope.downloadTasks=[],$scope.commentTasks=[],$scope.downloadHasMore=!1,$scope.switchTaskType=function(taskType,isMore){$scope.taskType=taskType;var tasksUrl;if(1==taskType){if($scope.downloadTasks.length>0&&isMore==-1)return;0==isMore?tasksUrl="/taskHall/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.downloadTasks&&0!=$scope.downloadTasks.length||$ionicLoading.show(),tasksUrl="/taskHall/"+taskType+"/"+gUserCId+"/"+$scope.downloadTasks.length/pageCount),$scope.downloadLoading=!0}else if(2==taskType){if($scope.commentTasks.length>0&&isMore==-1)return;0==isMore?tasksUrl="/taskHall/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.commentTasks&&0!=$scope.commentTasks.length||$ionicLoading.show(),tasksUrl="/taskHall/"+taskType+"/"+gUserCId+"/"+$scope.commentTasks.length/pageCount),$scope.commentLoading=!0}return void 0==tasksUrl?void console.error("tasksUrl == undefined"):void $http.get(tasksUrl).success(function(response){1==taskType?$scope.downloadLoading=!1:2==taskType&&($scope.commentLoading=!1),0==response.errorId?($scope.masterConfig=response.masterConfig,1==taskType?response.tasks.length>0&&(0==isMore&&($scope.downloadTasks=[]),$scope.downloadTasks=$scope.downloadTasks.concat(response.tasks)):2==taskType&&(response.tasks.length>0?(response.tasks.length==pageCount?$scope.commentHasMore=!0:$scope.commentHasMore=!1,0==isMore&&($scope.commentTasks=[]),$scope.commentTasks=$scope.commentTasks.concat(response.tasks)):$scope.commentHasMore=!1)):($scope.errorId=response.errorId,$scope.message=response.message)}).finally(function(){$ionicLoading.hide(),1==isMore&&$scope.$broadcast("scroll.infiniteScrollComplete"),0==isMore&&$scope.$broadcast("scroll.refreshComplete"),$timeout(function(){$scope.downloadTasks.length>0&&$scope.downloadTasks.length%pageCount==0?$scope.downloadHasMore=!0:$scope.downloadHasMore=!1},1e3)})},$scope.switchTaskType(1,-1),$scope.refreshTaskHall=function(){$scope.switchTaskType($scope.taskType,0)},$scope.loadMore=function(){1==$scope.downloadHasMore&&$scope.switchTaskType($scope.taskType,1)}}).controller("TaskDetailController",function($rootScope,$scope,$http,$location,FileUploader,$ionicPopup,$interval,$timeout,$ionicLoading,$ionicModal){function refreshMyTaskStatus(newTaskStatus){if(void 0!=$rootScope.retList){for(var pointerMyTask,pointerIndex,i=0;i<$rootScope.retList.length;i++){var myTask=$rootScope.retList[i];myTask.taskId==taskId&&(pointerMyTask=myTask,pointerIndex=i)}if("放弃任务"==newTaskStatus&&void 0!=pointerIndex)$rootScope.retList.splice(pointerIndex,1);else if(void 0==pointerMyTask){var myTaskObject=Object();myTaskObject.appIcon=$scope.taskDetail.appIcon,myTaskObject.appName=$scope.taskDetail.appName,myTaskObject.doTaskPrice=$scope.taskDetail.doTaskPrice,myTaskObject.taskId=taskId,myTaskObject.statusDes=newTaskStatus,myTaskObject.createdAt=$scope.doTaskCreatedAt,$rootScope.retList.unshift(myTaskObject)}else pointerMyTask.statusDes=newTaskStatus}}function showAlertError(errorMsg){var myPopup=$ionicPopup.show({title:errorMsg});$timeout(function(){myPopup.close()},2e3)}getUserCode();var appurlList=$location.absUrl().split("/"),taskId=appurlList[appurlList.length-1];$scope.lockTaskId=void 0,$scope.dataStatus=0;var taskDetailTimer;$scope.showAle=function(){$scope.bigImage=!0},$scope.bigImage=!1,$scope.hideBigImage=function(){$scope.bigImage=!1},$scope.showAle1=function(){$scope.bigImage1=!0},$scope.bigImage1=!1,$scope.hideBigImage1=function(){$scope.bigImage1=!1},$scope.showAle3=function(index){$scope.imgshow=!0,$scope.img_index=index},$scope.imgshow=!1,$scope.imghidden=function(){$scope.imgshow=!1},$scope.showAle2=function(){$scope.bigImage2=!0},$scope.bigImage2=!1,$scope.hideBigImage2=function(){$scope.bigImage2=!1},$scope.setwidth=function(taskType){var widthnew;return"下载"==taskType?widthnew="45%":"评论"==taskType&&(widthnew="30%"),{width:widthnew}},$scope.setwidth1=function(doTaskImgs){var widthnew1,length=$scope.taskDetail.doTaskImgs.length;return 2==length?widthnew1="45%":3==length&&(widthnew1="30%"),{width:widthnew1}};var tasksUrl="/taskHall/"+gUserCId+"/"+taskId;$scope.loading=!0,$ionicLoading.show(),$scope.userSpecialNeeds="",$http.get(tasksUrl).success(function(response){if($scope.loading=!1,0==response.errorId){$scope.taskDetail=response.taskDetail,$scope.lockTaskId=response.taskDetail.lockTaskId,$scope.dataStatus=1,$scope.tempTaskMaxTime=response.taskDetail.tempTaskMaxTime;var toastTask="";if(void 0!=response.taskDetail.specialNeeds)for(var i=0;i<response.taskDetail.specialNeeds.length;i++)$scope.userSpecialNeeds=response.taskDetail.specialNeeds[i];1==$scope.taskDetail.screenShotOne.needGet&&(toastTask+="该任务需要首次下载<br>"),"third"==$scope.taskDetail.screenShotTwo.registerStatus&&(toastTask+="该任务需要第三方登陆<br>"),1==$scope.taskDetail.screenShotThird.needMoreReviewContent&&(toastTask+="该任务需要超长评论<br>"),"on"==$scope.userSpecialNeeds.AppleID&&(toastTask+="该任务需要填写Apple ID<br>"),"on"==$scope.userSpecialNeeds.userNickName&&(toastTask+="该任务需要填写用户昵称<br>"),"on"==$scope.userSpecialNeeds.weChat&&(toastTask+="该任务需要填写微信号<br>"),toastTask.length>1&&$ionicPopup.confirm({title:"特殊任务要求提示",template:toastTask}),void 0!=$scope.lockTaskId&&(void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0),"uploaded"!=$scope.taskDetail.doTaskStatus&&(taskDetailTimer=$interval(function(){var leftTime,now=new Date,taskTimerStr=$scope.taskDetail.doTaskCreatedAt.replace(/-/g,"/"),taskDate=new Date(taskTimerStr);if("refused"==$scope.taskDetail.doTaskStatus){var nextDay=new Date(now.getTime()+864e5);nextDay.setHours(9),nextDay.setMinutes(0),nextDay.setSeconds(0),nextDay.setMilliseconds(0),leftTime=nextDay.getTime()-now.getTime()}else leftTime=$scope.tempTaskMaxTime-(now.getTime()-taskDate.getTime());if(leftTime<0)return void(void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0));if(""==$scope.taskDetail.doTaskStatus)return void(void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0));var leftSecond=parseInt(leftTime/1e3);leftSecond%=86400;var hour=Math.floor(leftSecond/3600);leftSecond%=3600;var minute=Math.floor(leftSecond/60);leftSecond%=60;var second=leftSecond,countDownStr=(hour>0?hour+":":"")+(minute>0?minute+":":"")+second;"uploaded"==$scope.taskDetail.doTaskStatus||"reUploaded"==$scope.taskDetail.doTaskStatus||"refused"==$scope.taskDetail.doTaskStatus?$scope.uploadButtonTitle="重新上传"+$scope.taskPicCount+"张任务截图  "+countDownStr:$scope.uploadButtonTitle="上传"+$scope.taskPicCount+"张任务截图  "+countDownStr},interval)),$scope.taskPicCount=response.taskDetail.taskPicCount,$scope.progressNum=0,"uploaded"==$scope.taskDetail.doTaskStatus||"reUploaded"==$scope.taskDetail.doTaskStatus||"refused"==$scope.taskDetail.doTaskStatus?$scope.uploadButtonTitle="重新上传"+$scope.taskPicCount+"张任务截图":$scope.uploadButtonTitle="上传"+$scope.taskPicCount+"张任务截图","refused"==response.taskDetail.doTaskStatus&&($scope.errorId=-1,$scope.errorMsg=response.taskDetail.refusedReason))}else $scope.errorId=response.errorId,$scope.message=response.message}).finally(function(){$ionicLoading.hide()});var locklock=0;$scope.lockTask=function(){if(1!=locklock){locklock=1,$ionicLoading.show();var lockTaskUrl="/taskHall/lockTask",lockParam={userCId:gUserCId,taskId:taskId};$http.post(lockTaskUrl,lockParam).success(function(response){if(locklock=0,0==response.errorId)$scope.lockTaskId=response.lockTaskId,$scope.doTaskCreatedAt=response.doTaskCreatedAt,$scope.taskPicCount=response.taskPicCount,$scope.uploadButtonTitle="上传"+$scope.taskPicCount+"张任务截图",$scope.progressNum=0,refreshMyTaskStatus("未完成"),void 0!=taskDetailTimer&&$interval.cancel(taskDetailTimer),taskDetailTimer=$interval(function(){var now=new Date,taskTimerStr=$scope.doTaskCreatedAt.replace(/-/g,"/"),taskDate=new Date(taskTimerStr),leftTime=$scope.tempTaskMaxTime-(now.getTime()-taskDate.getTime());if(leftTime<0)return void(void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0));var leftSecond=parseInt(leftTime/1e3);leftSecond%=86400;var hour=Math.floor(leftSecond/3600);leftSecond%=3600;var minute=Math.floor(leftSecond/60);leftSecond%=60;var second=leftSecond,countDownStr=(hour>0?hour+":":"")+(minute>0?minute+":":"")+second;"uploaded"==$scope.taskDetail.doTaskStatus||"reUploaded"==$scope.taskDetail.doTaskStatus||"refused"==$scope.taskDetail.doTaskStatus?$scope.uploadButtonTitle="重新上传"+$scope.taskPicCount+"张任务截图 "+countDownStr:$scope.uploadButtonTitle="上传"+$scope.taskPicCount+"张任务截图 "+countDownStr},interval);else if(response.errorId<=-100)var myPopup=$ionicPopup.show({title:response.message,buttons:[{text:"确定"}]});else{var myPopup=$ionicPopup.show({title:response.message});$timeout(function(){myPopup.close()},1500)}}).finally(function(){$ionicLoading.hide()})}};var unlocklock=0;$scope.unlockTask=function(){if(1!=unlocklock&&void 0!=$scope.lockTaskId){unlocklock=1,$ionicLoading.show();var lockTaskUrl="/taskHall/unlockTask",lockParam={userCId:gUserCId,lockTaskId:$scope.lockTaskId};$http.post(lockTaskUrl,lockParam).success(function(response){unlocklock=0,void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0),0==response.errorId&&($scope.lockTaskId=void 0,refreshMyTaskStatus("放弃任务"))}).finally(function(){$ionicLoading.hide()})}},$scope.preUploadFile=function(){$scope.imgError=1,uploader.clearQueue()},$scope.ert=$scope,$scope.clickImg=function(){var input;"on"==$scope.userSpecialNeeds.AppleID&&(input='Apple ID:<input type="text" ng-model="ert.appleId">'),"on"==$scope.userSpecialNeeds.userNickName&&(input='用户昵称:<input type="text" ng-model="ert.userNickName">'),"on"==$scope.userSpecialNeeds.weChat&&(input='填写微信:<input type="text" ng-model="ert.userWeChat">'),"on"==$scope.userSpecialNeeds.AppleID&&"on"==$scope.userSpecialNeeds.userNickName&&(input='Apple ID:<input type="text" ng-model="ert.appleId"><br>用户昵称:<input type="text" ng-model="ert.userNickName">'),"on"==$scope.userSpecialNeeds.userNickName&&"on"==$scope.userSpecialNeeds.weChat&&(input='用户昵称:<input type="text" ng-model="ert.userNickName"><br>填写微信:<input type="text" ng-model="ert.userWeChat">'),"on"==$scope.userSpecialNeeds.AppleID&&"on"==$scope.userSpecialNeeds.weChat&&(input='Apple ID:<input type="text" ng-model="ert.appleId"><br>填写微信:<input type="text" ng-model="ert.userWeChat">'),"on"==$scope.userSpecialNeeds.AppleID&&"on"==$scope.userSpecialNeeds.userNickName&&"on"==$scope.userSpecialNeeds.weChat&&(input='Apple ID:<input type="text" ng-model="ert.appleId"><br>用户昵称:<input type="text" ng-model="ert.userNickName"><br>填写微信:<input type="text" ng-model="ert.userWeChat">'),$ionicPopup.show({template:input,title:"用户输入内容",scope:$scope,buttons:[{text:"取消"},{text:"<b>确认</b>",type:"button-positive",onTap:function(){$scope.userInputDetail()}}]})};var userInputArray=Array();$scope.userInputDetail=function(){var ertObject=Object();""==$scope.ert.appleId&&void 0==$scope.ert.appleId||(ertObject.appleID=$scope.ert.appleId),""==$scope.ert.userNickName&&void 0==$scope.ert.userNickName||(ertObject.userNickName=$scope.ert.userNickName),""==$scope.ert.weChat&&void 0==$scope.ert.weChat||(ertObject.weChat=$scope.ert.weChat),userInputArray.push(ertObject)},window.localStorage?$scope.userCode=localStorage.getItem("userCode"):$scope.userCode=getCookie("userCode");var uploader=$scope.uploader=new FileUploader({url:"/upload/img",queueLimit:3});uploader.filters.push({name:"imageFilter",fn:function(item,options){var type="|"+item.type.slice(item.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|".indexOf(type)!==-1}});var fileUrls=new Array;uploader.onAfterAddingFile=function(fileItem){},uploader.onAfterAddingAll=function(addedFileItems){$scope.errorId=0,$scope.progressNum=5,uploader.uploadAll(),console.info("onAfterAddingAll",addedFileItems)},uploader.onProgressAll=function(progress){$scope.progressNum=.8*progress>10?.8*progress:10,console.info("onProgressAll",progress)},uploader.onSuccessItem=function(fileItem,response,status,headers){console.info("onSuccessItem",fileItem,response,status,headers)},uploader.onErrorItem=function(fileItem,response,status,headers){$scope.errorId=1,$scope.errorMsg="上传图片失败",console.info("onErrorItem",fileItem,response,status,headers)},uploader.onCancelItem=function(fileItem,response,status,headers){console.info("onCancelItem",fileItem,response,status,headers)},uploader.onCompleteItem=function(fileItem,response,status,headers){void 0!=response.files&&response.files.length>0?(fileUrls.push(response.files[0]),console.info("onCompleteItem",fileItem,response,status,headers)):($scope.errorId=-100,$scope.errorMsg="一张或多张图片上传失败,刷新网页重新上传")},uploader.onCompleteAll=function(){console.info("onCompleteAll");var Url="/taskHall/tempUserDoTask";return $scope.progressNum=90,fileUrls.length<$scope.taskPicCount?(showAlertError("图片个数不对,需要"+$scope.taskPicCount+"张图片"),$scope.progressNum=0,uploader.clearQueue(),void(fileUrls=Array())):""!=$scope.ert.appleId&&void 0!=$scope.ert.appleId||"on"!=$scope.userSpecialNeeds.AppleID?""!=$scope.ert.userNickName&&void 0!=$scope.ert.userNickName||"on"!=$scope.userSpecialNeeds.userNickName?""!=$scope.ert.weChat&&void 0!=$scope.ert.weChat||"on"!=$scope.userSpecialNeeds.weChat?0==userInputArray.length&&$scope.userSpecialNeeds.length>0?(showAlertError("必填项未填"),$scope.progressNum=0,uploader.clearQueue(),void(fileUrls=Array())):void $http.post(Url,{userCId:gUserCId,taskId:$scope.lockTaskId,uploadName:$scope.userCode,requirementImgs:fileUrls,userInputArray:userInputArray}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,console.log($scope.errorId),console.log($scope.errorMsg),0==$scope.errorId?(void 0!=taskDetailTimer&&($interval.cancel(taskDetailTimer),taskDetailTimer=void 0),$scope.downloadTasks="uploaded",$scope.doTaskImgs=response.requirementImgs,$scope.uploadButtonTitle="确认提交任务",$scope.nowUpladedImgs=1,refreshMyTaskStatus("审核中"),response.message.length>10&&$rootScope.showPhoneConfirm(response.message)):($scope.errorId=response.errorId,$scope.errorMsg=response.message),$scope.progressNum=0,uploader.clearQueue(),fileUrls=Array()}):(showAlertError("微信未填"),$scope.progressNum=0,uploader.clearQueue(),void(fileUrls=Array())):(showAlertError("用户昵称未填"),$scope.progressNum=0,uploader.clearQueue(),void(fileUrls=Array())):(showAlertError("AppleID未填"),$scope.progressNum=0,uploader.clearQueue(),void(fileUrls=Array()))},$scope.backlastpage=function(){"确认提交任务"==$scope.uploadButtonTitle&&window.history.back()},$scope.endTask=function(){}}).controller("MyTaskController",function($rootScope,$scope,$http,$interval,$timeout,$ionicLoading){getUserCode();var myTaskTimer;$scope.taskClick=function(clickTask){window.location.href="/app#/tab/myTask/"+clickTask.taskId},$scope.refreshMyTask=function(refreshTag){$http.post(tasksUrl,{userCId:gUserCId}).success(function(response){$ionicLoading.hide(),$scope.loading=!1,0==response.errorId?($scope.masterConfig=response.masterConfig,$rootScope.retList=response.retList,$scope.undoTask=response.undoTask,$scope.willGetRmb=response.willGetRmb,$scope.tempTaskMaxTime=response.tempTaskMaxTime,void 0!=myTaskTimer&&($interval.cancel(myTaskTimer),myTaskTimer=void 0),myTaskTimer=$interval(function(){for(var now=new Date,i=0;i<$scope.retList.length;i++){var myTaskObject=$scope.retList[i];if(void 0!=myTaskObject.createdAt){var taskTimerStr=myTaskObject.createdAt.replace(/-/g,"/"),taskDate=new Date(taskTimerStr),leftTime=$scope.tempTaskMaxTime-(now.getTime()-taskDate.getTime());if(leftTime<0)return void 0==myTaskObject.createdAt,myTaskObject.statusDes="已超时",void(void 0!=myTaskTimer&&($interval.cancel(myTaskTimer),myTaskTimer=void 0));var leftSecond=parseInt(leftTime/1e3);leftSecond%=86400;var hour=Math.floor(leftSecond/3600);leftSecond%=3600;var minute=Math.floor(leftSecond/60);leftSecond%=60;var second=leftSecond;myTaskObject.downcountDisplay=(hour>0?hour+"时":"")+(minute>0?minute+"分":"")+second+"秒"}}},interval)):($scope.errorId=response.errorId,$scope.message=response.message)}).finally(function(){$scope.$broadcast("scroll.refreshComplete")})};var tasksUrl="/taskHall/myTask";$ionicLoading.show(),$scope.refreshMyTask(-1)}).controller("AccountController",function($rootScope,$scope,$http,$timeout,$ionicLoading,$ionicPopup){function showAlertError(errorMsg){var myPopup=$ionicPopup.show({title:errorMsg});$timeout(function(){myPopup.close()},2e3)}getUserCode(),$scope.settings={enviarNotificaciones:!0},$scope.refreshTaskAccount=function(refreshTask){var accountUser="/taskUser/withdrawDeposit";$http.post(accountUser,{userCId:gUserCId}).success(function(response){$ionicLoading.hide(),$scope.temUserInfo=response.temUserInfo,$scope.canWithdrawMoney=response.temUserInfo.canWithdrawMoney,console.log($scope.canWithdrawMoney)}).finally(function(){$ionicLoading.hide(),1==refreshTask&&$scope.$broadcast("scroll.refreshComplete")})},$scope.refreshTaskAccount(1);var tempUserCode;tempUserCode=window.localStorage?localStorage.getItem("userCode"):getCookie("userCode");var accountUser="/taskUser/marketingApprenticeCount";$http.post(accountUser,{userCId:gUserCId,userCode:tempUserCode}).success(function(response){$scope.rewardMessages=response.rewardMessages,console.log($scope.canWithdrawMoney)}).finally(function(){}),$scope.getMarketingReward=function(){$ionicLoading.show();var accountUser="/taskUser/getMarketingApprenticeReward";$http.post(accountUser,{userCId:gUserCId,userCode:tempUserCode}).success(function(response){$ionicLoading.hide(),0==response.errorId?($scope.temUserIncanWithdrawMoney=response.temUserInfo.canWithdrawMoney,toastr.success(response.message)):toastr.error(response.message)}).finally(function(){$ionicLoading.hide()})};var bindLock=0;$rootScope.bindpay=function(type){if(1!=bindLock){var bindpay,binditem;if("aliAccount"==type){if(void 0==$scope.ctrlScope.inputaliAccount&&0==$scope.ctrlScope.inputaliAccount.length)return;binditem={userCId:gUserCId,aliAccount:$scope.ctrlScope.inputaliAccount},bindpay="/taskUser/bindAliPay"}else if("requestSms"==type){if(void 0==$scope.ctrlScope.phoneNumber&&0==$scope.ctrlScope.phoneNumber.length)return;binditem={userCId:gUserCId,phoneNumber:$scope.ctrlScope.phoneNumber},bindpay="/taskUser/requestSms"}else{if("bindPhone"!=type)return;if(void 0==$scope.ctrlScope.smsCode&&0==$scope.ctrlScope.smsCode.length)return;binditem={userCId:gUserCId,phoneNumber:$scope.ctrlScope.phoneNumber,smsCode:$scope.ctrlScope.smsCode},bindpay="/taskUser/bindPhone"}bindLock=1,$ionicLoading.show(),$http.post(bindpay,binditem).success(function(response){if($ionicLoading.hide(),bindLock=0,0==response.errorId)if("requestSms"==type)$rootScope.binderPhoneNumber();else{if(window.localStorage)try{localStorage.setItem("userCId",response.temUserInfo.userCId),localStorage.setItem("userCode",response.temUserInfo.userCode)}catch(e){return void alert("无痕模式无法正常使用小马哦,点击右下角后,再点击左下角关闭无痕模式")}else setCookie("userCId",response.temUserInfo.userCId),setCookie("userCode",response.temUserInfo.userCode),alert("set cookie succeed");getUserCode(),$scope.temUserInfo=response.temUserInfo,"bindPhone"==type&&alert("赞！绑定手机号成功,小马会在每天下午2-3点放出大量任务")}else showAlertError(response.message)})}};var askForWithdrawLock=0;$scope.askForWithdraw=function(){if(1!=askForWithdrawLock){var withdrawUrl="/taskUser/withDraw",params={userCId:gUserCId};askForWithdrawLock=1,$ionicLoading.show(),$http.post(withdrawUrl,params).success(function(response){$ionicLoading.hide(),askForWithdrawLock=0,0==response.errorId?(alert("提现成功"),$scope.temUserInfo=response.temUserInfo):showAlertError(response.message)})}},$scope.ctrlScope=$scope,$scope.showConfirm=function(){$ionicPopup.show({template:'<input type="text" ng-model="ctrlScope.inputaliAccount">',title:"绑定你的支付宝",scope:$scope,buttons:[{text:"取消"},{text:"<b>绑定</b>",type:"button-positive",onTap:function(){$rootScope.bindpay("aliAccount")}}]})},$rootScope.binderPhoneNumber=function(){$ionicPopup.show({template:'<input type="text" placeholder="验证码" ng-model="ctrlScope.smsCode">',title:"输入你的验证码",scope:$scope,buttons:[{text:"取消"},{text:"<b>绑定</b>",type:"button-positive",onTap:function(){$rootScope.bindpay("bindPhone")}}]})},$rootScope.showPhoneConfirm=function(popTitle){$ionicPopup.show({template:'<input type="text" placeholder="手机号" ng-model="ctrlScope.phoneNumber">',title:popTitle,scope:$scope,buttons:[{text:"取消"},{text:"<b>获取验证码</b>",type:"button-positive",onTap:function(){$rootScope.bindpay("requestSms")}}]})},$scope.Withdraw=function(){if($scope.canWithdrawMoney<$scope.temUserInfo.minUserWithDrawRMB){var alertPopup=$ionicPopup.alert({title:"满"+$scope.temUserInfo.minUserWithDrawRMB+"元方可提现",subTitle:"每次提现金额为"+$scope.temUserInfo.minUserWithDrawRMB+"的整数倍"});$timeout(function(){alertPopup.close()},2e3)}else $scope.askForWithdraw()}}).controller("currentAssetDetailController",function($scope,$http,$ionicLoading){getUserCode();var pageCount=20;$scope.downloadTasks=[],$scope.commentTasks=[],$scope.apprenticeInfo=[],$scope.withdrawDeposits=[],$scope.switchQueryType=function(taskType,isnMore){$scope.taskType=taskType;var currentAssURL;if(1==taskType){if($scope.downloadTasks.length>0&&isnMore==-1)return;0==isnMore?currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.downloadTasks&&0!=$scope.downloadTasks.length||$ionicLoading.show(),currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/"+$scope.downloadTasks.length/pageCount),$scope.downloadLoading=!0}else if(2==taskType){if($scope.commentTasks.length>0&&isnMore==-1)return;0==isnMore?currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.commentTasks&&0!=$scope.commentTasks.length||$ionicLoading.show(),currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/"+$scope.commentTasks.length/pageCount),$scope.commentloadLoading=!0}else if(3==taskType){if($scope.apprenticeInfo.length>0&&isnMore==-1)return;0==isnMore?currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.apprenticeInfo&&0!=$scope.apprenticeInfo.length||$ionicLoading.show(),currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/"+$scope.apprenticeInfo.length/pageCount),$scope.apprenticeloadLoading=!0}else if(4==taskType){if($scope.withdrawDeposits.length>0&&isnMore==-1)return;0==isnMore?currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/0":(void 0!=$scope.withdrawDeposits&&0!=$scope.withdrawDeposits.length||$ionicLoading.show(),currentAssURL="/taskUserDetails/currentAsset/"+taskType+"/"+gUserCId+"/"+$scope.withdrawDeposits.length/pageCount),$scope.withdrawloadHasMore=!0}$http.get(currentAssURL).success(function(response){1==taskType?response.retApps.length>0&&(0==isnMore&&($scope.downloadTasks=[]),$scope.downloadTasks=$scope.downloadTasks.concat(response.retApps)):2==taskType?response.retApps.length>0?(response.retApps.length==pageCount?$scope.commentloadLoading=!0:$scope.commentloadLoading=!1,0==isnMore&&($scope.commentTasks=[]),$scope.commentTasks=$scope.commentTasks.concat(response.retApps)):$scope.commentloadLoading=!1:3==taskType?response.discipleArray.length>0?(response.discipleArray.length==pageCount?$scope.apprenticeloadLoading=!0:$scope.apprenticeloadLoading=!1,0==isnMore&&($scope.apprenticeInfo=[]),$scope.apprenticeInfo=$scope.apprenticeInfo.concat(response.discipleArray)):$scope.apprenticeloadLoading=!1:4==taskType&&(response.depositsList.length>0?(response.depositsList.length==pageCount?$scope.withdrawloadHasMore=!0:$scope.withdrawloadHasMore=!1,0==isnMore&&($scope.withdrawDeposits=[]),$scope.withdrawDeposits=$scope.withdrawDeposits.concat(response.depositsList)):$scope.withdrawloadHasMore=!1),0==response.errorId?($scope.retApps=response.retApps,$scope.depositsList=response.depositsList,$scope.discipleArray=response.discipleArray):($scope.errorId=response.errorId,$scope.message=response.message)}).finally(function(){$ionicLoading.hide(),1==isnMore&&$scope.$broadcast("scroll.infiniteScrollComplete"),0==isnMore&&$scope.$broadcast("scroll.refreshComplete")})},$scope.switchQueryType(1,-1),$scope.loadMore=function(){$scope.switchQueryType($scope.taskType,1)}});