var app=angular.module("userAccountApp",[]);app.controller("userAccountCtrl",function($scope,$http,$location){function validateMobile(mobile){if(0==mobile.length)return alert("手机号码未填写！"),!1;if(11!=mobile.length)return alert("请输入有效的手机号码！"),!1;var myreg=/^(((13[0-9]{1})|(15[0-9]{1})|(14[0-9]{1})|(17[0-9]{1})|(18[0-9]{1}))+\d{8})$/;return!!myreg.test(mobile)||(alert("请输入有效的手机号码！"),!1)}$scope.displayMsg=function(){console.log($scope.errorMsg),"Could not find user"===$scope.errorMsg?$(".alert").text("无法找到用户"):"The username and password mismatch."===$scope.errorMsg?$(".alert").text("用户名与密码不符"):$(".alert").text($scope.errorMsg)},$scope.userRegister=function(){var registerUrl="/user/register";console.log($location.absUrl());var registerParams=$location.absUrl().split("/"),inviteCode=registerParams.pop();inviteCode.length<15&&(inviteCode=void 0),$http.post(registerUrl,{inviteCode:inviteCode,mobile:$scope.userMobile,password:$scope.userSecret,smsCode:$scope.userSmsCode}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.displayMsg(),0==response.errorId?location.href="/homePage":$scope.errorMsg=response.errorMsg})},$scope.userLogin=function(){var registerUrl="/user/login";console.log($scope.userSmsCode),$http.post(registerUrl,{mobile:$scope.userMobile,password:$scope.userSecret}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.displayMsg(),0==response.errorId&&(location.href="/homePage")})},$scope.getNewSmsCode=function(){function countdown(seconds){return 0===seconds?($("#button1").attr("disabled",!1),void $("#button1").text("重获验证码")):($("#button1").text(seconds+"s后重试"),seconds--,void setTimeout(function(){countdown(seconds)},1e3))}if(""!=$scope.searchUrl){var registerUrl="/user/getNewSmsCode";console.log(registerUrl),$("#button1").prop("disabled",!0);var seconds=60;countdown(seconds),$http.post(registerUrl,{mobile:$scope.userMobile,password:$scope.userSecret}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.displayMsg()})}},$scope.newSecret=function(){var registerUrl="/user/forgetSecret";console.log($scope.userSmsCode),$http.post(registerUrl,{mobile:$scope.userMobile,smsCode:$scope.newSmsCode,newPassword:$scope.usernewSecret}).success(function(response){$scope.errorId=response.errorId,$scope.errorMsg=response.errorMsg,$scope.displayMsg(),0==response.errorId&&(location.href="/user/login")})};var handlerEmbed=function(captchaObj){$("#getSmsBtn").click(function(e){function countdown(seconds){0===seconds?($("#getSmsBtn").attr("disabled",!1),$("#getSmsBtn").text("获取验证码")):($("#getSmsBtn").text(seconds+"s后重试"),seconds--,setTimeout(function(){countdown(seconds)},1e3))}if(void 0==$scope.userMobile||void 0==$scope.userSecret)return void alert("手机号和密码必填哦");var isMobileValid=validateMobile($scope.userMobile);if(1==isMobileValid){var patrn=/^(\w){6,20}$/;if(!patrn.exec($scope.userSecret))return void alert("密码由6-20个字母/数字或下划线组成");if(1==isMobileValid){var validate=captchaObj.getValidate();if(validate){$("#getSmsBtn").prop("disabled",!0);var seconds=60;countdown(seconds);var registerUrl="/user/getSmsCode",smsParams={geetest_challenge:validate.geetest_challenge,geetest_validate:validate.geetest_validate,geetest_seccode:validate.geetest_seccode,mobile:$scope.userMobile,password:$scope.userSecret};$scope.isError=0,$http.post(registerUrl,smsParams).success(function(response){$scope.errorId=response.errorId,response.errorMsg.length>0?($scope.isError=1,$scope.errorMsg=response.errorMsg):$scope.isError=0,$scope.displayMsg()})}else $("#notice")[0].className="show",setTimeout(function(){$("#notice")[0].className="hide"},2e3)}}}),captchaObj.appendTo("#embed-captcha"),captchaObj.onReady(function(){$("#wait")[0].className="hide"})};$.ajax({url:"/user/pc-geetest/register?t="+(new Date).getTime(),type:"get",dataType:"json",success:function(data){initGeetest({gt:data.gt,challenge:data.challenge,product:"embed",offline:!data.success},handlerEmbed)}})});