var app=angular.module("yemaWebApp",[]),navIndex=4;app.controller("nextTaskCheckCtrl",function($scope,$http,$location){function convertFilesToBase64String(src,name,callback,outputFormat){var img=new Image;img.crossOrigin="Anonymous",img.onload=function(){console.log("---- onload  "+src);var dataURL,canvas=document.createElement("CANVAS"),ctx=canvas.getContext("2d");canvas.height=this.height,canvas.width=this.width,ctx.drawImage(this,0,0),dataURL=canvas.toDataURL(outputFormat),callback(name,dataURL)},(img.complete||void 0===img.complete)&&(console.log("---- complete  "+src),img.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",img.src=src),img.src=src}function createZip(imgArrays){for(var zip=new JSZip,img=zip.folder("截图"),i=0;i<imgArrays.length;i++){var imgObject=imgArrays[i];img.file(imgObject.name,imgObject.dataUrl.substr(imgObject.dataUrl.indexOf(",")+1),{base64:!0})}zip.generateAsync({type:"blob"}).then(function(content){downloadLock=!1,$scope.downloadProgress=0,saveAs(content,$scope.app.trackName.substring(0,5)+"_"+$scope.app.searchKeyword+".zip")})}$scope.refusedReasons=[],void 0==$scope.customRefusedReason,$scope.refusedReasons.push({des:"任务设备错误 或 为无卡机",canRedo:!1}),$scope.refusedReasons.push({des:"下错APP 或 少图 或 传错图片",canRedo:!0}),$scope.refusedReasons.push({des:"同一台手机任务图提交多次任务",canRedo:!0}),$scope.refusedReasons.push({des:"图二 未跳过引导页",canRedo:!0});var refusedEntry;$scope.refusedClick=function(entry){refusedEntry=entry};var refusedReasonIndex=void 0;$scope.checkRefusedReason=function(){refusedReasonIndex=parseInt($scope.selectReason)},$scope.selectRefusedReason=function(){if(void 0!=$scope.customRefusedReason&&$scope.customRefusedReason.length>0)$scope.userCustomRefuseReason();else{var refusedObject=$scope.refusedReasons[refusedReasonIndex];$scope.reject(refusedObject.des,refusedObject.canRedo)}},$scope.userCustomRefuseReason=function(){var refusedObject={};refusedObject.des=$scope.customRefusedReason,$scope.refusedReasons.unshift(refusedObject),$scope.reject($scope.customRefusedReason,refusedObject.canRedo)},$scope.isLoadingMyApp=!0,$scope.currentTaskId=void 0,$scope.noApp=!1,$scope.myObj=Object();var appurlList=$location.absUrl().split("/"),taskObjectId=appurlList[appurlList.length-1];$scope.getTaskImgs=function(taskType){$scope.isLoadingMyApp=!0,$scope.app=void 0,$scope.taskType=taskType;var taskUrl="/nextTaskCheck/taskAudit/"+taskObjectId+"/"+taskType;$http.get(taskUrl).success(function(response){$scope.isLoadingMyApp=!1,$scope.app=response.app,$scope.refusedReasons.unshift({des:"图一 搜索关键词错误(应该为:"+$scope.app.searchKeyword+")",canRedo:!0}),"third"==$scope.app.registerStatus&&$scope.refusedReasons.unshift({des:"图二 未第三方登录",canRedo:!0}),1==$scope.app.needGet&&$scope.refusedReasons.unshift({des:"非首次下载App：图一无获取按钮",canRedo:!1}),"评论"==$scope.app.taskType&&($scope.refusedReasons.push({des:"没有先打开App试玩, 再评论",canRedo:!0}),$scope.refusedReasons.push({des:"图三 未隐藏键盘",canRedo:!0}),$scope.refusedReasons.push({des:"图三 评星错误",canRedo:!0}),$scope.refusedReasons.push({des:"图三 评论标题或评论内容 字数不足",canRedo:!0}),$scope.refusedReasons.push({des:"图三 领取的是多条任务，但未用流量评论",canRedo:!0})),void 0!=$scope.app.reviewMustTitleKey&&$scope.app.reviewMustTitleKey.length>0&&$scope.refusedReasons.push({des:"图三 评论标题未含必选词",canRedo:!0}),void 0!=$scope.app.reviewMustContentKey&&$scope.app.reviewMustContentKey.length>0&&$scope.refusedReasons.push({des:"图三 评论内容未含必选词",canRedo:!0}),void 0!=$scope.app.statusHistory&&$scope.app.statusHistory.length>0&&$scope.app.statusHistory.indexOf("refused")>=0&&$scope.refusedReasons.push({des:"屡次被拒绝后重复提交（但未正确的去重做任务）",canRedo:!1});var maxDisplayTask=20;"uploaded"==taskType&&(maxDisplayTask=100),$scope.app.submissions.length>maxDisplayTask?(toastr.info("任务过多，最多显示"+maxDisplayTask+"个任务，操作成功后，刷新页面显示剩下的任务(批量下载会下载全部的任务图片"),$scope.displaySubmissions=$scope.app.submissions.slice(0,maxDisplayTask)):$scope.displaySubmissions=$scope.app.submissions})},$scope.getTaskImgs("uploaded");var acceptLock=0;$scope.accept=function(entry){if(1!=acceptLock){acceptLock=1;var entryId=entry.id,url="/nextTaskCheck/accept/"+entryId;$http.post(url).success(function(response){acceptLock=0,0==response.errorId?(entry.status="accepted",toastr.success("接受任务成功,棒棒哒",{timeOut:2e3})):toastr.error(response.errorMsg)})}},$scope.fadeit=!0,$scope.showTask=function(){$scope.fadeit=!1},$scope.showTask1=function(){$scope.fadeit=!0},$scope.checkText=function(){$scope.myObj.rejectReason.length>20&&void 0!=$scope.myObj.userCustom&&($scope.myObj.rejectReason=$scope.myObj.rejectReason.substr(0,20))},$scope.reject=function(refusedReason,formalRedo){var entryId=refusedEntry.id;if($scope.required=!1,refusedReason.length>0){var url="/nextTaskCheck/reject/"+entryId,reject_reason={refusedReason:refusedReason,formalRedo:formalRedo};$http.post(url,reject_reason).success(function(response){0==response.errorId?($("#rejectReasonModel").modal("hide"),$scope.customRefusedReason="",refusedEntry.status="refused",toastr.success("拒绝成功",{timeOut:2e3})):toastr.error(response.errorMsg)})}else $scope.required=!0},$scope.addApp=function(id){$("#"+id).popover("toggle")};var downloadLock=!1;$scope.downloadProgress=0,$scope.downloadImgs=function(){function recursionDownloadImgs(start,submissions){for(var batchCount=0,batchLockCount=0,qujian=entriesLength-start>batchEntries?batchEntries:entriesLength-start,i=start;i<start+qujian;i++)for(var submission=submissions[i],j=0;j<submission.entries.length;j++){var entry=submission.entries[j],imgs=entry.imgs;batchCount+=imgs.length;for(var k=0;k<imgs.length;k++)console.log("---- "+k+" "+imgs[k]),convertFilesToBase64String(imgs[k],entry.uploadName+"_"+i+"__"+k,function(name,dataUrl){var base64img=new Object;base64img.dataUrl=dataUrl,base64img.name=name+".png",base64imgs.push(base64img),batchLockCount++,$scope.downloadProgress=parseFloat(base64imgs.length/totalImgs).toFixed(3),$scope.$apply(),console.log($scope.downloadProgress+" ---- "+batchLockCount+" "+batchCount),batchCount==batchLockCount&&recursionDownloadImgs(start+qujian,$scope.app.submissions),console.log("---- "+base64imgs.length+" "+totalImgs),base64imgs.length==totalImgs&&(toastr.info("图片下载成功，开始压缩图片"),createZip(base64imgs))},"png")}}if("accepted"!=$scope.taskType&&"uploaded"!=$scope.taskType)return void toastr.error("暂时只提供 已经提交/审核通过 的图片下载");if(1==downloadLock)return void toastr.info("图片下载任务进行中，请耐心等待上一个任务完成");downloadLock=!0;for(var base64imgs=[],totalImgs=0,jj=0;jj<$scope.app.submissions.length;jj++)for(var submission=$scope.app.submissions[jj],kk=0;kk<submission.entries.length;kk++){var entry=submission.entries[kk],imgs=entry.imgs;totalImgs+=imgs.length}totalImgs>50&&toastr.info("开始下载"+totalImgs+"图片，大概需要"+parseInt(totalImgs/100*2.5)+"分钟");var batchEntries=50,entriesLength=$scope.app.submissions.length;recursionDownloadImgs(0,$scope.app.submissions)}});